{% extends "index.html" %}
{% block content %}
<div class="p-4">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold">Switches</h1>
    <a href="{% url 'dashboard' %}" class="text-white bg-cyan-600 hover:bg-cyan-700 focus:ring-4 focus:ring-cyan-200 font-medium rounded-lg text-sm px-4 py-2">Dashboard</a>
  </div>

  <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
    <table class="w-full text-sm text-left text-gray-500">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3">Hostname</th>
          <th scope="col" class="px-6 py-3">IP</th>
          <th scope="col" class="px-6 py-3">Status</th>
          <th scope="col" class="px-6 py-3">Min RX</th>
          <th scope="col" class="px-6 py-3">Min TX</th>
          <th scope="col" class="px-6 py-3">Branch</th>
          <th scope="col" class="px-6 py-3">ATS</th>
          <th scope="col" class="px-6 py-3">Actions</th>
        </tr>
      </thead>
      <tbody id="switches-body"></tbody>
    </table>
  </div>
</div>

<script>
  async function loadSwitches() {
    const resp = await fetch('/snmp/api/switches/', { credentials: 'same-origin' });
    if (!resp.ok) {
      console.error('API error', resp.status);
      return;
    }
    const data = await resp.json();
    renderSwitches(data);
  }

  function badge(status) {
    const cls = status ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
    const label = status ? 'UP' : 'DOWN';
    return `<span class="text-xs font-medium me-2 px-2.5 py-0.5 rounded ${cls}">${label}</span>`;
  }

  function renderSwitches(items) {
    const body = document.getElementById('switches-body');
    body.innerHTML = items.map(s => {
      const branch = s.branch ? s.branch.name : '';
      const ats = s.ats ? s.ats.name : '';
      const minRx = (s.min_rx ?? '').toString();
      const minTx = (s.min_tx ?? '').toString();
      return `
        <tr class="bg-white border-b" data-switch-id="${s.id}">
          <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${s.hostname ?? ''}</td>
          <td class="px-6 py-4">${s.ip ?? ''}</td>
          <td class="px-6 py-4" data-field="status">${badge(s.status)}</td>
          <td class="px-6 py-4" data-field="min_rx">${minRx}</td>
          <td class="px-6 py-4" data-field="min_tx">${minTx}</td>
          <td class="px-6 py-4">${branch}</td>
          <td class="px-6 py-4">${ats}</td>
          <td class="px-6 py-4"><a class="text-blue-600 hover:underline" href="/snmp/switches/${s.id}/">Open</a></td>
        </tr>
      `;
    }).join('');
  }

  // Realtime updates
  window.addEventListener('monitoring:snapshot', (e) => {
    const sw = e.detail.switches || [];
    for (const s of sw) {
      const row = document.querySelector(`tr[data-switch-id="${s.id}"]`);
      if (!row) continue;
      row.querySelector('[data-field="status"]').innerHTML = badge(s.status);
      row.querySelector('[data-field="min_rx"]').textContent = s.min_rx ?? '';
      row.querySelector('[data-field="min_tx"]').textContent = s.min_tx ?? '';
    }
  });

  loadSwitches();
</script>
{% endblock %}
