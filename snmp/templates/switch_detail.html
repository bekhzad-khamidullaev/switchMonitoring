{% extends 'index.html' %}
{% block content %}
<div class="p-4" data-switch-id="{{ switch.id }}">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-2xl font-bold">{{ switch.hostname }} ({{ switch.ip }})</h1>
      <p class="text-gray-600">Realtime обновления через WSS</p>
    </div>
    <a href="{% url 'switches' %}" class="text-white bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-4 py-2">Back</a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 bg-white border rounded-lg shadow">
      <div class="text-gray-500">Status</div>
      <div id="sw-status" class="text-2xl font-bold">—</div>
    </div>
    <div class="p-4 bg-white border rounded-lg shadow">
      <div class="text-gray-500">Min RX</div>
      <div id="sw-min-rx" class="text-2xl font-bold">—</div>
    </div>
    <div class="p-4 bg-white border rounded-lg shadow">
      <div class="text-gray-500">Min TX</div>
      <div id="sw-min-tx" class="text-2xl font-bold">—</div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white border rounded-lg shadow p-4">
      <h2 class="text-xl font-bold mb-2">Interfaces / Optics</h2>
      <div class="relative overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
            <tr>
              <th class="px-4 py-2">ifIndex</th>
              <th class="px-4 py-2">Descr</th>
              <th class="px-4 py-2">Admin</th>
              <th class="px-4 py-2">Oper</th>
              <th class="px-4 py-2">RX</th>
              <th class="px-4 py-2">TX</th>
            </tr>
          </thead>
          <tbody id="ifaces-body"></tbody>
        </table>
      </div>
    </div>

    <div class="bg-white border rounded-lg shadow p-4">
      <h2 class="text-xl font-bold mb-2">MAC table</h2>
      <div class="relative overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
            <tr>
              <th class="px-4 py-2">VLAN</th>
              <th class="px-4 py-2">MAC</th>
              <th class="px-4 py-2">ifIndex</th>
            </tr>
          </thead>
          <tbody id="mac-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const switchId = Number(document.querySelector('[data-switch-id]').dataset.switchId);

  async function loadDetail() {
    const [ifacesResp, macResp] = await Promise.all([
      fetch(`/snmp/api/interfaces/?switch_id=${switchId}`, { credentials: 'same-origin' }),
      fetch(`/snmp/api/mac/?switch_id=${switchId}`, { credentials: 'same-origin' }),
    ]);

    const ifaces = ifacesResp.ok ? await ifacesResp.json() : [];
    const macs = macResp.ok ? await macResp.json() : [];

    document.getElementById('ifaces-body').innerHTML = ifaces.map(i => {
      return `
        <tr class="border-b">
          <td class="px-4 py-2">${i.ifindex}</td>
          <td class="px-4 py-2">${i.description ?? ''}</td>
          <td class="px-4 py-2">${i.admin ?? ''}</td>
          <td class="px-4 py-2">${i.oper ?? ''}</td>
          <td class="px-4 py-2">${i.optics?.rx_dbm ?? ''}</td>
          <td class="px-4 py-2">${i.optics?.tx_dbm ?? ''}</td>
        </tr>
      `;
    }).join('');

    document.getElementById('mac-body').innerHTML = macs.slice(0, 200).map(m => {
      return `
        <tr class="border-b">
          <td class="px-4 py-2">${m.vlan}</td>
          <td class="px-4 py-2 font-mono">${m.mac}</td>
          <td class="px-4 py-2">${m.interface ?? ''}</td>
        </tr>
      `;
    }).join('');
  }

  function badge(status) {
    return status ? 'UP' : 'DOWN';
  }

  window.addEventListener('monitoring:snapshot', (e) => {
    const sw = (e.detail.switches || []).find(s => s.id === switchId);
    if (!sw) return;
    document.getElementById('sw-status').textContent = badge(sw.status);
    document.getElementById('sw-min-rx').textContent = sw.min_rx ?? '';
    document.getElementById('sw-min-tx').textContent = sw.min_tx ?? '';
  });

  loadDetail();
</script>
{% endblock %}
